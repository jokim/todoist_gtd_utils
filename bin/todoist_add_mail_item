#!/bin/env python
# -*- encoding: utf-8 -*-

""" Create an item (task) in Todoist from piping mails from mutt.

Meant to be called from mutt by piping the full mail to the script. Example of
macro config for mutt::

    macro index,pager GG "<pipe-entry>less > \
        /tmp/mutt-$USER-mail-todoist.tmp<enter>\
        <shell-escape>todoist_add_mail_item \
            /tmp/mutt-$USER-mail-todoist.tmp<enter>"

You will then be asked for content, project, labels and date.

TODOs:

- Add unittesting!
- Add bash coloring
- Prettify presentation of mail headers on multiple, indented lines
- Support signals, like CTRL+C and CTRL+D when getting input

"""

from __future__ import unicode_literals
from __future__ import print_function

import sys
import signal
from threading import Thread
import argparse
import todoist_gtd_utils
import todoist_gtd_utils.mail
from todoist_gtd_utils import utils
from todoist_gtd_utils import TodoistGTD
from todoist_gtd_utils import userinput as ui


def signal_handler(signal, frame):
    """Prettier abort"""
    print("\nQuit, not commit")
    sys.exit(0)


def gather_input(content, api, args, project=None):
    """Ask user for info about the new item."""
    content, proj, date, labels, priority = ui.parse_content(api, content)

    print()
    # TODO: colorize invalid project and label names (# and @), to highlight
    # what looks like typos
    print(content)
    print()

    if not project:
        projects = set(unicode(p['name']) for p in api.projects.all())
        project = ui.ask_choice('Project', choices=projects, default=proj,
                                category="project")
    all_labels = set(unicode(l['name']).lower() for l in api.labels.all())
    labels = ui.ask_multichoice('Labels', choices=all_labels, default=labels,
                                category="labels")
    date = ui.ask_choice('Date', choices=ui.dateformats, default=date,
                         category="date", regex_choices=True)
    priority = ui.ask_choice('Priority', choices=['1', '2', '3', '4'],
                             default=priority, category="priority")
    return content, project, date, labels, priority


def create_api(args):
    """Setup the Todoist API.

    To be called in a thread, which is why it adds the api through the `global`
    syntax.

    """
    global api
    api = TodoistGTD(configfiles=args.configfile, token=args.token)
    if api.is_authenticated():
        api.sync()

if __name__ == '__main__':
    signal.signal(signal.SIGINT, signal_handler)
    p = ui.get_argparser(usage="%(prog)s [options] MAILFILE",
                         description=__doc__)
    p.add_argument('mail', metavar="MAILFILE", type=argparse.FileType('r'),
                   help="Mail to store as note. Defaults to piped input, e.g. "
                   "from mutt",
                   )
    args = p.parse_args()
    mail = todoist_gtd_utils.mail.SimpleMailParser(args.mail)

    print()
    print(mail.get_presentation('Date', 'From', '_Sender', 'To', '_Cc',
                                'Subject', body=False))
    print()
    print(utils.trim_too_long(mail.get_body(), 1000))
    # TODO: trim out quoted text, if not enough space in 1000 chars (or 20
    # lines)
    print()

    t = Thread(target=create_api, name='create_api', kwargs={'args': args})
    t.start()

    what = ui.ask_choice('New project or single task?', default='task',
                         choices=['project', 'task'])
    goal = None
    if what == 'project':
        goal = unicode(raw_input("Project end goal: "), 'utf-8')
    next = unicode(raw_input("Next action: "), 'utf-8')

    t.join()

    # Authenticate
    if not api.is_authenticated():
        ui.login_dialog(api)
        api.sync()

    if goal:
        parent = api.get_projects_by_name('Work')
        sub_pr = api.get_child_projects(parent)
        # - ask for what position
        pos = ui.ask_choice_of_list("Where to put new project:",
                                    api.get_project_name(sub_pr))
        pos = sub_pr[pos]['item_order']
        new_pr = api.projects.add(goal, indent=parent['indent'] + 1,
                                  color=parent['color'], item_order=pos)
        i = api.items.add('* Original request', project_id=new_pr['id'])
        api.notes.add(i['id'], mail.get_presentation('Date', '*From', 'To',
                                                     'Message-Id', '_Reply-To',
                                                     '*Subject', '_Sender'))
        api.force_commit()
        print("Project created")

    while True:
        next, project, date, labels, priority = gather_input(next, api, args,
                                                             project=goal)
        api_pri = utils.frontend_priority_to_api(priority)

        # Add emoji for mark that item came by email:
        i = api.items.add(next + ' :email:.', priority=api_pri, indent=1,
                          project_id=api.get_projects_by_name(project)['id'],
                          date_string=date, labels=api.get_label_id(labels))
        print("\nNew item:\n{}\n".format(i))
        if ui.ask_confirmation("Okay to create?", args):
            api.force_commit()

            api.notes.add(i['id'], mail.get_presentation('Date', '*From', 'To',
                                                         'Message-Id',
                                                         '_Reply-To',
                                                         '*Subject',
                                                         '_Sender'))
            api.force_commit()
            print("\nItem created")
            api.sync()
            new = api.items.all(lambda x: x['id'] == i['id'])[0]
            print(new)
            break
        else:
            print("\nGoing all over again...\n")
            next = unicode(raw_input("What is it? "), 'utf-8')
